<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>L·ªãch Sinh Ho·∫°t C·ªông ƒê·ªìng - T·ªï D√¢n Ph·ªë</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/a2d9b6f9a6.js" crossorigin="anonymous"></script>

  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    .sidebar {
      width: 250px;
      background-color: #0f3c3c;
      color: white;
      min-height: 100vh;
      padding: 20px;
      flex-shrink: 0;
    }
    .content { 
        flex: 1; 
        padding: 24px; 
        min-height:100vh; 
        background:#f9f9f9;
        overflow-x: auto; 
    }
    .sidebar .menu button { 
      color: white; 
      text-align: left; 
      background: none; 
      border: none; 
      width:100%; 
      padding: 8px 12px;
    }
    .sidebar .menu button:hover { background:#135353; border-radius:6px;}

    /* Title + controls */
    .page-header { gap: 12px; align-items: center; display:flex; flex-wrap:wrap; justify-content:space-between; }
    .header-left { display:flex; gap:12px; align-items:center; min-width:0; }
    .person-title { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Small helpers */
    .filter-row { gap:12px; margin-top:12px; display:flex; flex-wrap:wrap; }
    .table-wrap { margin-top:18px; }

    /* Make headers indicate sortable */
    th.sortable { cursor: pointer; user-select: none; }
    th .sort-ind { font-size:0.85em; opacity:0.6; margin-left:6px; }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-overlay.show {
      display: flex;
    }

    /* small responsive tweaks */
    @media (max-width: 1200px) {
      .sidebar { width: 200px; }
    }
    @media (max-width: 992px) {
      .sidebar { width: 160px; }
    }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .content { padding: 12px; }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">ƒêang t·∫£i...</span>
    </div>
  </div>

  <div class="d-flex">
    <!-- Sidebar -->
    <aside class="sidebar d-flex flex-column justify-content-between">
      <div>
        <h4 class="mb-4">NH√ìM 14</h4>
        <div class="menu">
          <button onclick="goTo('user_home.html')" class="mb-2">TRANG CH·ª¶</button>
          <button onclick="goTo('thong_tin_ca_nhan.html')" class="mb-2">TH√îNG TIN C√Å NH√ÇN</button>
          <button onclick="goTo('cap_nhat_thong_tin.html')" class="mb-2">C·∫¨P NH·∫¨T TH√îNG TIN</button>
          <button style="background:#135353; border-radius:6px;" class="mb-2">L·ªäCH SINH HO·∫†T</button>
        </div>
      </div>

      <div>
        <div class="d-flex align-items-center mb-2" onclick="logout()" style="cursor:pointer">
          <i class="fa-solid fa-right-from-bracket me-2"></i><span>ƒêƒÉng xu·∫•t</span>
        </div>
        <div class="d-flex align-items-center profile">
          <img src="/avatar.jpg" alt="avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover" />
          <div class="ms-2" id="usernameDisplay">C∆∞ d√¢n</div>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="content flex-fill">
      <!-- Header / Controls -->
      <div class="page-header">
        <div class="header-left">
          <div>
            <h3 class="mb-0 person-title" id="pageTitle">L·ªãch Sinh ho·∫°t C·ªông ƒë·ªìng T·ªï D√¢n Ph·ªë 14</h3>
            <small class="text-muted">Xem th√¥ng tin c√°c s·ª± ki·ªán v√† ho·∫°t ƒë·ªông c·ªông ƒë·ªìng</small>
          </div>
        </div>
      </div>

      <!-- Search & Filters -->
      <div class="filter-row align-items-center">
        <div class="input-group" style="min-width:260px; flex:1; max-width:520px;">
          <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
          <input id="searchInput" class="form-control" placeholder="T√¨m theo ti√™u ƒë·ªÅ, n·ªôi dung ho·∫∑c ng∆∞·ªùi ph·ª• tr√°ch...">
          <button class="btn btn-outline-secondary" id="clearSearchBtn" title="X√≥a">√ó</button>
        </div>

        <div class="d-flex gap-2">
          <select id="filterType" class="form-select">
            <option value="All">T·∫•t c·∫£ lo·∫°i</option>
            <option value="H·ªçp T·ªï d√¢n ph·ªë">H·ªçp T·ªï d√¢n ph·ªë</option>
            <option value="Ho·∫°t ƒë·ªông An ninh/V·ªá sinh">Ho·∫°t ƒë·ªông An ninh/V·ªá sinh</option>
            <option value="S·ª± ki·ªán VƒÉn h√≥a/Th·ªÉ thao">S·ª± ki·ªán VƒÉn h√≥a/Th·ªÉ thao</option>
            <option value="Thu ph√≠/ƒê√≥ng g√≥p">Thu ph√≠/ƒê√≥ng g√≥p</option>
            <option value="Th√¥ng b√°o Kh·∫©n c·∫•p">Th√¥ng b√°o Kh·∫©n c·∫•p</option>
          </select>

          <select id="filterStatus" class="form-select">
            <option value="All">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="S·∫Øp di·ªÖn ra">S·∫Øp di·ªÖn ra</option>
            <option value="ƒê√£ t·ªï ch·ª©c">ƒê√£ t·ªï ch·ª©c</option>
            <option value="Th√¥ng b√°o ƒëang hi·ªáu l·ª±c">Th√¥ng b√°o ƒëang hi·ªáu l·ª±c</option>
          </select>
        </div>
      </div>

      <!-- Table -->
      <div class="table-wrap">
        <div class="table-responsive">
          <table class="table table-hover align-middle" id="eventsTable">
            <thead class="table-light">
              <tr>
                <th class="sortable" data-key="thoi_gian_bat_dau">Ng√†y &amp; Gi·ªù B·∫Øt ƒë·∫ßu <span class="sort-ind">‚ñ≤‚ñº</span></th>
                <th class="sortable" data-key="loai">Lo·∫°i Ho·∫°t ƒë·ªông</th>
                <th class="sortable" data-key="tieu_de">Ti√™u ƒë·ªÅ</th>
                <th class="sortable" data-key="dia_diem">ƒê·ªãa ƒëi·ªÉm</th>
                <th class="sortable" data-key="nguoi_phu_trach">Ng∆∞·ªùi Ph·ª• tr√°ch</th>
                <th class="sortable" data-key="trang_thai">Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="eventsTbody">
              <tr>
                <td colspan="7" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal: View Event (Read-only) -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Xem Chi ti·∫øt S·ª± ki·ªán/Th√¥ng b√°o</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label fw-bold">Ti√™u ƒë·ªÅ</label>
            <div class="col-sm-9">
              <p class="form-control-plaintext" id="viewTitle">-</p>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label fw-bold">Lo·∫°i Ho·∫°t ƒë·ªông</label>
            <div class="col-sm-9">
              <p class="form-control-plaintext" id="viewType">-</p>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label fw-bold">Ng√†y &amp; Gi·ªù B·∫Øt ƒë·∫ßu</label>
            <div class="col-sm-9">
              <p class="form-control-plaintext" id="viewStart">-</p>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label fw-bold">Ng√†y &amp; Gi·ªù K·∫øt th√∫c</label>
            <div class="col-sm-9">
              <p class="form-control-plaintext" id="viewEnd">-</p>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label fw-bold">ƒê·ªãa ƒëi·ªÉm</label>
            <div class="col-sm-9">
              <p class="form-control-plaintext" id="viewLocation">-</p>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label fw-bold">Ng∆∞·ªùi Ph·ª• tr√°ch</label>
            <div class="col-sm-9">
              <p class="form-control-plaintext" id="viewActor">-</p>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label fw-bold">N·ªôi dung Chi ti·∫øt</label>
            <div class="col-sm-9">
              <p class="form-control-plaintext" id="viewDesc" style="white-space: pre-wrap;">-</p>
            </div>
          </div>

          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label fw-bold">Tr·∫°ng th√°i</label>
            <div class="col-sm-9">
              <p class="form-control-plaintext" id="viewStatus">-</p>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE = 'http://localhost:3000/api/events';
    const tbody = document.getElementById('eventsTbody');
    const loadingOverlay = document.getElementById('loadingOverlay');
    let allEvents = [];
    let currentSort = { key: 'thoi_gian_bat_dau', dir: 'desc' };

    // ===========================
    // API Functions
    // ===========================
    async function fetchEvents() {
      try {
        showLoading(true);
        const params = new URLSearchParams();
        
        const search = document.getElementById('searchInput').value.trim();
        const loai = document.getElementById('filterType').value;
        const trangThai = document.getElementById('filterStatus').value;
        
        if (search) params.append('search', search);
        if (loai !== 'All') params.append('loai', loai);
        if (trangThai !== 'All') params.append('trangThai', trangThai);
        if (currentSort.key) {
          params.append('sortKey', currentSort.key);
          params.append('sortDir', currentSort.dir);
        }

        const url = `${API_BASE}?${params.toString()}`;
        const response = await fetch(url);
        
        if (!response.ok) throw new Error('L·ªói khi t·∫£i d·ªØ li·ªáu');
        
        allEvents = await response.json();
        renderTable();
      } catch (error) {
        console.error('Error fetching events:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.</td></tr>';
      } finally {
        showLoading(false);
      }
    }

    // ===========================
    // UI Functions
    // ===========================
    function formatDateTime(dt) {
      if (!dt) return '';
      const d = new Date(dt);
      if (isNaN(d.getTime())) return dt;
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    }

    function typeIcon(type) {
      const icons = {
        'H·ªçp T·ªï d√¢n ph·ªë': 'üì£',
        'Ho·∫°t ƒë·ªông An ninh/V·ªá sinh': 'üóëÔ∏è',
        'S·ª± ki·ªán VƒÉn h√≥a/Th·ªÉ thao': 'üéâ',
        'Thu ph√≠/ƒê√≥ng g√≥p': 'üí∞',
        'Th√¥ng b√°o Kh·∫©n c·∫•p': 'üö®'
      };
      return icons[type] || 'üìã';
    }

    function statusBadge(status) {
      const badges = {
        'S·∫Øp di·ªÖn ra': '<span class="badge bg-warning text-dark">S·∫Øp di·ªÖn ra</span>',
        'ƒê√£ t·ªï ch·ª©c': '<span class="badge bg-success">ƒê√£ t·ªï ch·ª©c</span>',
        'Th√¥ng b√°o ƒëang hi·ªáu l·ª±c': '<span class="badge bg-info text-dark">Th√¥ng b√°o ƒëang hi·ªáu l·ª±c</span>'
      };
      return badges[status] || `<span class="badge bg-light text-dark">${status}</span>`;
    }

    function renderTable() {
      tbody.innerHTML = '';
      
      if (allEvents.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Kh√¥ng c√≥ s·ª± ki·ªán n√†o</td></tr>';
        return;
      }

      allEvents.forEach(ev => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="white-space:nowrap">${formatDateTime(ev.thoiGianBatDau)}</td>
          <td>${typeIcon(ev.loai)} <span class="ms-1">${ev.loai}</span></td>
          <td style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:bold" title="${ev.tieuDe}">${ev.tieuDe}</td>
          <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${ev.diaDiem || ''}">${ev.diaDiem || '-'}</td>
          <td>${ev.nguoiPhuTrach || '-'}</td>
          <td>${statusBadge(ev.trangThai)}</td>
          <td>
            <button class="btn btn-sm btn-outline-info" title="Xem chi ti·∫øt" onclick="viewEvent(${ev.id})">
              <i class="fa-regular fa-eye"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function showLoading(show) {
      loadingOverlay.classList.toggle('show', show);
    }

    // ===========================
    // Event Handlers
    // ===========================
    document.getElementById('searchInput').addEventListener('input', () => {
      clearTimeout(window.searchTimeout);
      window.searchTimeout = setTimeout(() => fetchEvents(), 500);
    });

    document.getElementById('clearSearchBtn').addEventListener('click', () => {
      document.getElementById('searchInput').value = '';
      fetchEvents();
    });

    document.getElementById('filterType').addEventListener('change', fetchEvents);
    document.getElementById('filterStatus').addEventListener('change', fetchEvents);

    // Sorting
    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        if (currentSort.key === key) {
          currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.key = key;
          currentSort.dir = 'asc';
        }
        fetchEvents();
      });
    });

    // View Event (Read-only)
    async function viewEvent(id) {
      try {
        showLoading(true);
        const response = await fetch(`${API_BASE}/${id}`);
        if (!response.ok) throw new Error('Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán');
        
        const ev = await response.json();
        
        document.getElementById('viewTitle').textContent = ev.tieuDe || '-';
        document.getElementById('viewType').innerHTML = `${typeIcon(ev.loai)} ${ev.loai || '-'}`;
        document.getElementById('viewStart').textContent = formatDateTime(ev.thoiGianBatDau) || '-';
        document.getElementById('viewEnd').textContent = formatDateTime(ev.thoiGianKetThuc) || '-';
        document.getElementById('viewLocation').textContent = ev.diaDiem || '-';
        document.getElementById('viewActor').textContent = ev.nguoiPhuTrach || '-';
        document.getElementById('viewDesc').textContent = ev.moTa || '-';
        document.getElementById('viewStatus').innerHTML = statusBadge(ev.trangThai);

        new bootstrap.Modal(document.getElementById('eventModal')).show();
      } catch (error) {
        console.error('Error loading event:', error);
        alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·ª± ki·ªán');
      } finally {
        showLoading(false);
      }
    }

    // ===========================
    // Navigation
    // ===========================
    function goTo(p) { window.location.href = p; }
    function logout() { 
      localStorage.removeItem('username'); 
      window.location.href = '/'; 
    }

    // ===========================
    // Initialize
    // ===========================
    document.addEventListener('DOMContentLoaded', () => {
      const username = localStorage.getItem('username') || 'C∆∞ d√¢n';
      document.getElementById('usernameDisplay').textContent = username;
      fetchEvents();
    });
  </script>
</body>
</html>